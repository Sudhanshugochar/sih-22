<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficiary Credit Scoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #aab2c0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #8e9aaf; }
        .modal-scale-enter { animation: scale-in 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        .modal-scale-leave { animation: scale-out 0.3s cubic-bezier(0.550, 0.085, 0.680, 0.530) both; }
        @keyframes scale-in { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes scale-out { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.95); opacity: 0; } }
        .table-row-hover:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); z-index: 10; position: relative; }
        .card-glow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); transition: all 0.3s ease-in-out; }
        .card-glow:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1), 0 4px 6px -4px rgba(79, 70, 229, 0.1); }
        .stamp { border: 5px double; border-radius: 50%; width: 150px; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; text-transform: uppercase; animation: stamp-in 0.5s cubic-bezier(0.175, 0.885, 0.320, 1.275) both; }
        .stamp-approved { color: #16a34a; border-color: #16a34a; }
        .stamp-denied { color: #dc2626; border-color: #dc2626; }
        .stamp-review { color: #f59e0b; border-color: #f59e0b; }
        @keyframes stamp-in { 0% { transform: scale(2); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .loader { border: 2px solid #e9e9e9; border-top: 2px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-dot { position: absolute; top: 2px; right: 2px; width: 10px; height: 10px; background-color: #dc2626; border-radius: 50%; border: 2px solid white; }
        @keyframes progress-bar { 0% { width: 0%; } 100% { width: 100%; } }
        .progress-bar-animated { animation: progress-bar 1.5s ease-out forwards; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-30 relative">
            <div class="max-w-screen-2xl mx-auto px-8 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/80px-Emblem_of_India.svg.png" alt="Emblem of India" class="h-14 w-auto">
                    <div>
                        <h1 class="text-2xl font-black text-slate-800 tracking-tight">Beneficiary Credit Scoring</h1>
                        <p class="text-sm text-slate-500">Ministry of Social Justice & Empowerment (MoSJE)</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-sm text-slate-600 text-right">
                        <p class="font-bold">Samajik Nyay Aur Shashaktikaran Vibhag</p>
                        <p class="text-xs text-slate-400">Theme: Smart Automation</p>
                    </div>
                    <div class="relative">
                        <button id="notification-btn" class="text-slate-500 hover:text-indigo-600">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <span class="notification-dot"></span>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-30 border">
                            <div class="p-3 font-semibold text-sm border-b">Notifications</div>
                            <div class="p-2 space-y-2 text-sm max-h-80 overflow-y-auto">
                                <div class="p-2 rounded hover:bg-slate-50"><strong>New Applicant:</strong> BEN013 requires assessment.</div>
                                <div class="p-2 rounded hover:bg-slate-50"><strong>Loan Default:</strong> BEN007 has missed 3+ payments.</div>
                                <div class="p-2 rounded hover:bg-slate-50"><strong>Approved:</strong> Loan for BEN001 sanctioned successfully.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-1.5 flex">
                <div class="h-full w-1/3" style="background-color: #FF9933"></div> <div class="h-full w-1/3 bg-white"></div>
                <div class="h-full w-1/3" style="background-color: #138808"></div> </div>
        </header>

        <main class="max-w-screen-2xl mx-auto px-8 py-8">
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl card-glow flex items-center justify-between border-l-8 border-blue-500">
                    <div><p class="text-sm font-medium text-slate-500">Total Beneficiaries</p><p class="text-4xl font-extrabold text-slate-800" id="total-beneficiaries">0</p></div>
                    <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-2xl card-glow flex items-center justify-between border-l-8 border-green-500">
                    <div><p class="text-sm font-medium text-slate-500">Low Risk - High Need</p><p class="text-4xl font-extrabold text-slate-800" id="low-risk-high-need">0</p></div>
                    <div class="bg-green-100 p-4 rounded-full"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-2xl card-glow flex items-center justify-between border-l-8 border-indigo-500">
                    <div><p class="text-sm font-medium text-slate-500">Digital Loans Sanctioned</p><p class="text-4xl font-extrabold text-slate-800" id="loans-disbursed">0</p></div>
                    <div class="bg-indigo-100 p-4 rounded-full"><svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-2xl card-glow flex items-center justify-between border-l-8 border-amber-500">
                    <div><p class="text-sm font-medium text-slate-500">Avg. Approval Time</p><p class="text-4xl font-extrabold text-slate-800" id="approval-rate">24 Hrs</p></div>
                    <div class="bg-amber-100 p-4 rounded-full"><svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg card-glow">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Risk Band Distribution</h2>
                    <div class="h-80 flex items-center justify-center"><canvas id="risk-distribution-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg card-glow">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Loan Status Distribution</h2>
                    <div class="h-80 flex items-center justify-center"><canvas id="loan-status-chart"></canvas></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Beneficiary Credit Analysis</h2>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto items-stretch">
                            <input type="text" id="search-beneficiary" placeholder="Search..." class="w-full sm:w-40 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <select id="filter-risk-band" class="w-full sm:w-36 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition bg-white"><option value="all">All Risk Bands</option></select>
                            <select id="filter-loan-status" class="w-full sm:w-36 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition bg-white"><option value="all">All Statuses</option></select>
                            <button id="add-beneficiary-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Add New</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg">Beneficiary</th>
                                    <th scope="col" class="px-6 py-3">Composite Score</th>
                                    <th scope="col" class="px-6 py-3">Risk Band</th>
                                    <th scope="col" class="px-6 py-3">Loan Status</th>
                                    <th scope="col" class="px-6 py-3 text-center rounded-r-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="beneficiary-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg card-glow">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Direct Digital Lending</h2>
                        <div class="space-y-4" id="lending-form">
                                <div>
                                    <label for="loan-beneficiary-id" class="block text-sm font-medium text-slate-700">Beneficiary ID</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" id="loan-beneficiary-id" placeholder="e.g., BEN001" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <button id="suggest-amount-btn" class="flex-shrink-0 bg-slate-200 text-slate-700 font-semibold text-sm py-2 px-3 rounded-md hover:bg-slate-300 transition-colors">Suggest Amount</button>
                                    </div>
                                </div>
                            <div><label for="loan-amount" class="block text-sm font-medium text-slate-700">Loan Amount (₹)</label><input type="number" id="loan-amount" placeholder="e.g., 50000" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button id="check-eligibility-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 flex items-center justify-center space-x-2 disabled:bg-indigo-400 text-base"><span id="btn-text">Check Eligibility & Sanction</span><div id="btn-loader" class="loader hidden"></div></button>
                        </div>
                        <div id="lending-result" class="mt-6 text-center hidden"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg card-glow">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">ML Model Operations</h2>
                        <div id="retrain-feedback" class="hidden p-3 mb-4 text-sm text-center rounded-lg"></div>
                        <div class="space-y-3">
                           <div class="flex justify-between items-center text-sm">
                                <span class="font-medium text-slate-600">Current Model Accuracy:</span>
                                <span id="model-accuracy" class="font-bold text-green-600 text-lg">91.4%</span>
                           </div>
                           <p class="text-xs text-slate-500 italic">Simulate retraining the model with new beneficiary performance data to improve its predictive power.</p>
                           <button id="retrain-model-btn" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors flex items-center justify-center space-x-2 disabled:bg-slate-500">
                               <span id="retrain-btn-text">Retrain Model</span>
                               <div id="retrain-loader" class="loader hidden"></div>
                           </button>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-lg card-glow">
                         <h2 class="text-xl font-bold text-slate-800 mb-4">Update & Re-Score</h2>
                         <div class="space-y-4">
                             <div><label for="rescore-beneficiary-select" class="block text-sm font-medium text-slate-700">Select Beneficiary</label><select id="rescore-beneficiary-select" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                             <div><label for="new-electricity" class="block text-sm font-medium text-slate-700">New Electricity Usage (kWh)</label><input type="number" id="new-electricity" placeholder="e.g., 275" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                             <div><label for="new-mobile" class="block text-sm font-medium text-slate-700">New Mobile Recharge Avg (₹)</label><input type="number" id="new-mobile" placeholder="e.g., 550" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                             <button id="rescore-btn" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors">Update & Re-Score</button>
                             <div id="rescore-result" class="mt-2 text-center text-sm font-medium"></div>
                         </div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <div id="beneficiary-modal" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div class="flex items-center space-x-4 mb-6 pb-4 border-b border-slate-200"><img id="modal-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full border-4 border-slate-200"><div><h2 id="modal-name" class="text-2xl font-bold"></h2><p id="modal-id" class="text-sm text-slate-500"></p></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                <div>
                    <h3 class="font-semibold text-lg mb-4">Credit Score Analysis</h3>
                    <div class="space-y-4">
                        <div class="text-center bg-slate-50 p-4 rounded-lg"><p class="text-sm text-slate-600">Composite Beneficiary Score</p><p id="modal-composite-score" class="text-5xl font-bold text-blue-600"></p><p id="modal-risk-band" class="mt-1 font-semibold px-3 py-1 text-sm rounded-full inline-block"></p></div>
                        <div class="grid grid-cols-3 gap-2 text-center"><div class="bg-blue-50 p-3 rounded-lg"><p class="text-xs text-blue-800 font-semibold">Repayment</p><p id="modal-repayment-score" class="text-xl font-bold text-blue-700"></p></div><div class="bg-green-50 p-3 rounded-lg"><p class="text-xs text-green-800 font-semibold">Income</p><p id="modal-income-score" class="text-xl font-bold text-green-700"></p></div><div class="bg-red-50 p-3 rounded-lg"><p class="text-xs text-red-800 font-semibold">Fraud Risk</p><p id="modal-fraud-score" class="text-xl font-bold text-red-700"></p></div></div>
                    </div>
                    <div class="mt-8"><h3 class="font-semibold text-lg mb-2">Historical Loan Performance</h3><canvas id="repayment-chart"></canvas></div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-4">Score Explainability (XAI)</h3>
                    <div class="bg-slate-50 p-4 rounded-lg">
                         <p class="text-sm font-bold text-slate-800 mb-2">Key Score Factors:</p>
                        <div id="xai-breakdown" class="space-y-3"></div>
                    </div>
                    <h3 class="font-semibold text-lg mb-4 mt-8">Consumption & Profile</h3>
                    <div class="bg-slate-50 p-4 rounded-lg space-y-3 text-sm">
                        <div class="flex justify-between"><span class="font-medium text-slate-600">Business Activity:</span><span id="modal-business-activity" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="font-medium text-slate-600">Location:</span><span id="modal-location" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="font-medium text-slate-600">Electricity Usage:</span><span id="modal-electricity" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="font-medium text-slate-600">Utility Bill Payments:</span><span id="modal-utility" class="font-bold"></span></div>
                    </div>
                    <h3 class="font-semibold text-lg mb-4 mt-8">Audit Trail</h3>
                    <div id="audit-trail" class="bg-slate-50 p-4 rounded-lg text-xs text-slate-500 space-y-2 max-h-32 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-beneficiary-modal" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div id="add-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 relative">
             <button id="close-add-modal-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
             <h2 class="text-2xl font-bold text-slate-800 mb-6">Add New Beneficiary & Apply for Loan</h2>
             <form id="add-beneficiary-form" class="space-y-4">
                 <div><label for="new-name" class="block text-sm font-medium text-slate-700">Full Name</label><input type="text" id="new-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div><label for="new-location" class="block text-sm font-medium text-slate-700">Location</label><input type="text" id="new-location" placeholder="e.g., Nagpur, MH" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div><label for="new-business" class="block text-sm font-medium text-slate-700">Business Activity</label><input type="text" id="new-business" placeholder="e.g., Retail Shop" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div><label for="new-electricity-add" class="block text-sm font-medium text-slate-700">Avg. Electricity Usage (kWh)</label><input type="number" id="new-electricity-add" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div><label for="new-mobile-add" class="block text-sm font-medium text-slate-700">Avg. Mobile Recharge (₹)</label><input type="number" id="new-mobile-add" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="border-t pt-4 space-y-4">
                    <p class="text-sm text-center text-slate-500">Enter loan details if applying now. Leave blank to only register the beneficiary.</p>
                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label for="new-loan-amount" class="block text-sm font-medium text-slate-700">Loan Amount Requested (₹)</label>
                             <input type="number" id="new-loan-amount" placeholder="e.g., 25000" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                         </div>
                         <div>
                             <label for="new-loan-tenure" class="block text-sm font-medium text-slate-700">Loan Tenure (Months)</label>
                             <input type="number" id="new-loan-tenure" placeholder="e.g., 12" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                         </div>
                     </div>
                 </div>
                 <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">Create Beneficiary</button>
             </form>
        </div>
    </div>

    <footer class="bg-slate-800 text-slate-300 mt-16">
        <div class="max-w-screen-2xl mx-auto px-8 py-12 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
            <div>
                <div class="flex items-center space-x-3 mb-4">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/80px-Emblem_of_India.svg.png" alt="Emblem of India" class="h-12 w-auto bg-white p-1 rounded-full">
                    <div>
                        <h3 class="font-bold text-white text-lg">MoSJE</h3>
                        <p class="text-xs text-slate-400">Govt. of India</p>
                    </div>
                </div>
                <p class="text-sm">Empowering beneficiaries through transparent and automated credit assessment.</p>
            </div>
            
            <div>
                <h4 class="font-semibold text-white mb-4 tracking-wider">Quick Links</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white transition-colors">Dashboard Home</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">Generate Reports</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">User Management</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">Audit Logs</a></li>
                </ul>
            </div>

            <div>
                <h4 class="font-semibold text-white mb-4 tracking-wider">Resources</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white transition-colors">Help & Documentation</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">Privacy Policy</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">Terms of Use</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">Accessibility Statement</a></li>
                </ul>
            </div>
            
            <div>
                <h4 class="font-semibold text-white mb-4 tracking-wider">Associated With</h4>
                <div class="flex items-center space-x-4">
                    <img src="https://upload.wikimedia.org/wikipedia/en/thumb/4/42/Digital_India_logo.svg/320px-Digital_India_logo.svg.png" alt="Digital India" class="h-8 brightness-0 invert opacity-70 hover:opacity-100 transition">
                    <img src="https://upload.wikimedia.org/wikipedia/en/thumb/b/b8/MyGov.in_logo.svg/320px-MyGov.in_logo.svg.png" alt="MyGov" class="h-7 brightness-0 invert opacity-70 hover:opacity-100 transition">
                </div>
            </div>
        </div>
        <div class="bg-slate-900">
            <div class="max-w-screen-2xl mx-auto px-8 py-4 text-sm text-slate-400 flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                <p>&copy; 2025 Ministry of Social Justice & Empowerment. All Rights Reserved.</p>
                <p class="mt-2 sm:mt-0">Designed & Developed by National Informatics Centre (NIC)</p>
            </div>
        </div>
    </footer>

    <button id="back-to-top" class="hidden fixed bottom-6 right-6 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 flex items-center justify-center z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
    </button>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- MOCK DATA & CONFIG ---
    let mockBeneficiaries = [
        { id: 'BEN001', name: 'Aarav Sharma', location: 'Nagpur, MH', loanAmount: 50000, tenure: 12, repayments: 12, business: 'Retail Shop', electricity: 250, mobile: 499, utility: 'On-Time', repeat: true, loanStatus: 'Closed' },
        { id: 'BEN002', name: 'Priya Patel', location: 'Mumbai, MH', loanAmount: 30000, tenure: 12, repayments: 10, business: 'Tailoring', electricity: 150, mobile: 299, utility: 'On-Time', repeat: false, loanStatus: 'Active' },
        { id: 'BEN003', name: 'Rohan Singh', location: 'Pune, MH', loanAmount: 75000, tenure: 24, repayments: 15, business: 'Farming', electricity: 400, mobile: 199, utility: '1 Late', repeat: true, loanStatus: 'Active' },
        { id: 'BEN004', name: 'Sneha Reddy', location: 'Hyderabad, TS', loanAmount: 20000, tenure: 6, repayments: 6, business: 'Handicrafts', electricity: 120, mobile: 399, utility: 'On-Time', repeat: false, loanStatus: 'Closed' },
        { id: 'BEN005', name: 'Vikram Kumar', location: 'Delhi, DL', loanAmount: 100000, tenure: 36, repayments: 18, business: 'Food Stall', electricity: 600, mobile: 799, utility: '2 Late', repeat: true, loanStatus: 'Active' },
        { id: 'BEN006', name: 'Anjali Gupta', location: 'Nagpur, MH', loanAmount: 45000, tenure: 18, repayments: 18, business: 'Beauty Parlor', electricity: 350, mobile: 599, utility: 'On-Time', repeat: true, loanStatus: 'Closed' },
        { id: 'BEN007', name: 'Sanjay Yadav', location: 'Lucknow, UP', loanAmount: 60000, tenure: 24, repayments: 5, business: 'Transport', electricity: 550, mobile: 999, utility: '3+ Late', repeat: false, loanStatus: 'Defaulted' },
        { id: 'BEN008', name: 'Meera Desai', location: 'Ahmedabad, GJ', loanAmount: 25000, tenure: 12, repayments: 12, business: 'Pottery', electricity: 90, mobile: 149, utility: 'On-Time', repeat: false, loanStatus: 'Closed' },
        { id: 'BEN009', name: 'Karan Malhotra', location: 'Chandigarh, CH', loanAmount: 85000, tenure: 24, repayments: 22, business: 'IT Services', electricity: 700, mobile: 1299, utility: 'On-Time', repeat: true, loanStatus: 'Active' },
        { id: 'BEN010', name: 'Sunita Devi', location: 'Jaipur, RJ', loanAmount: 15000, tenure: 12, repayments: 3, business: 'Street Vendor', electricity: 80, mobile: 99, utility: '2 Late', repeat: false, loanStatus: 'Active' },
        { id: 'BEN011', name: 'Amit Singh', location: 'Bhopal, MP', loanAmount: 95000, tenure: 36, repayments: 10, business: 'Manufacturing', electricity: 900, mobile: 899, utility: '1 Late', repeat: false, loanStatus: 'Active' },
        { id: 'BEN012', name: 'Rekha Mishra', location: 'Patna, BR', loanAmount: 40000, tenure: 18, repayments: 18, business: 'Coaching Center', electricity: 450, mobile: 699, utility: 'On-Time', repeat: true, loanStatus: 'Closed' },
    ];
    let dashboardMetrics = { loansDisbursed: 1284 };
    const riskBandConfig = {
        'Low Risk - High Need': { color: '#16a34a', text: 'white' }, 'Low Risk - Low Need': { color: '#0d9488', text: 'white' },
        'Medium Risk - High Need': { color: '#f59e0b', text: 'white' }, 'Medium Risk - Low Need': { color: '#eab308', text: 'black' },
        'High Risk - High Need': { color: '#f97316', text: 'white' }, 'High Risk - Low Need': { color: '#ef4444', text: 'white' }
    };
    let repaymentChart = null;
    let riskChart = null;
    let loanStatusChart = null;
    
    // --- DYNAMIC ML MODEL SIMULATION ---
    let modelWeights = {
        accuracy: 91.4,
        repayment: { base: 500, ratio_good: 200, ratio_ok: 150, ratio_fair: 50, ratio_poor: -100, repeat: 100, defaulted: -200, late_utility_penalty: 25 },
        income: { base: 1150, elec_high: 150, elec_med: 100, elec_low: -100, mobile_high: 100, mobile_med: 50, mobile_low: -50 },
        fraud: { base: 10, high_loan_no_repeat: 30, low_elec_high_mobile: 40 },
        composite: { repayment_w: 0.5, income_w: 0.3, fraud_penalty: 150, constant: 200 }
    };

    const getScoreFactors = (b) => {
        const w = modelWeights;
        const repaymentRatio = (b.tenure > 0) ? b.repayments / b.tenure : 0;
        const factors = {
            repaymentPerformance: {
                label: 'Repayment Performance',
                value: repaymentRatio >= 1 ? w.repayment.ratio_good : repaymentRatio > 0.8 ? w.repayment.ratio_ok : repaymentRatio > 0.5 ? w.repayment.ratio_fair : w.repayment.ratio_poor,
                description: `Repayment rate is ${Math.round(repaymentRatio*100)}%`
            },
            repeatBorrower: { label: 'Repeat Borrower', value: b.repeat ? w.repayment.repeat : 0, description: 'Beneficiary has a history of previous loans' },
            defaultStatus: { label: 'Default Status', value: b.loanStatus === 'Defaulted' ? w.repayment.defaulted : 0, description: 'Loan is in a defaulted state' },
            utilityPayments: {
                label: 'Utility Bill Payments',
                value: - (b.utility.includes('Late') ? (parseInt(b.utility.split(' ')[0]) || 1) * w.repayment.late_utility_penalty : 0),
                description: `Utility payment record: ${b.utility}`
            },
            electricityUsage: {
                label: 'Electricity Consumption',
                value: b.electricity > 500 ? w.income.elec_high : b.electricity > 300 ? w.income.elec_med : b.electricity < 100 ? w.income.elec_low : 0,
                description: `Electricity usage is ${b.electricity} kWh/month`
            },
            mobileRecharge: {
                label: 'Mobile Recharge Amount',
                value: b.mobile > 700 ? w.income.mobile_high : b.mobile > 400 ? w.income.mobile_med : b.mobile < 200 ? w.income.mobile_low : 0,
                description: `Average mobile recharge is ₹${b.mobile}`
            }
        };
        return factors;
    };
    
    const calculateRepaymentScore = (b, factors) => Math.round(modelWeights.repayment.base + factors.repaymentPerformance.value + factors.repeatBorrower.value + factors.defaultStatus.value + factors.utilityPayments.value);
    const calculateIncomeScore = (b, factors) => Math.round(modelWeights.income.base - (500 + factors.electricityUsage.value + factors.mobileRecharge.value));
    const detectFraudRisk = (b) => Math.min(100, modelWeights.fraud.base + (b.loanAmount > 80000 && !b.repeat ? modelWeights.fraud.high_loan_no_repeat : 0) + (b.electricity < 100 && b.mobile > 900 ? modelWeights.fraud.low_elec_high_mobile : 0));
    const calculateCompositeScore = (r, i, f) => Math.round(r * modelWeights.composite.repayment_w + i * modelWeights.composite.income_w - (f / 100) * modelWeights.composite.fraud_penalty + modelWeights.composite.constant);
    const getRiskBand = (r, i) => `${r < 550 ? 'High Risk' : r < 700 ? 'Medium Risk' : 'Low Risk'} - ${i > 600 ? 'High Need' : 'Low Need'}`;

    // --- FULL PAGE RE-RENDER FUNCTION ---
    const fullRefresh = () => {
        applyFilters();
        updateDashboardCards(mockBeneficiaries);
        renderRiskDistributionChart(mockBeneficiaries);
        renderLoanStatusChart(mockBeneficiaries);
        populateDropdowns();
    };

    // --- UI RENDERING FUNCTIONS ---
    const renderTable = (beneficiaries) => {
        const tableBody = document.getElementById('beneficiary-table-body');
        tableBody.innerHTML = '';
        if (beneficiaries.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No beneficiaries found for the selected filters.</td></tr>`;
            return;
        }
        beneficiaries.forEach(b => {
            const factors = getScoreFactors(b);
            const r = calculateRepaymentScore(b, factors), i = calculateIncomeScore(b, factors), f = detectFraudRisk(b);
            const compositeScore = calculateCompositeScore(r, i, f);
            const riskBand = getRiskBand(r, i);
            const riskConfig = riskBandConfig[riskBand] || { color: 'gray', text: 'white' };
            const scoreColor = compositeScore > 750 ? 'green-600' : compositeScore > 600 ? 'amber-500' : 'red-600';
            const statusMap = { 'Active': 'text-blue-500', 'Closed': 'text-green-500', 'Defaulted': 'text-red-500', 'Newly Sanctioned': 'text-indigo-500 font-semibold', 'Pending': 'text-amber-500 font-semibold', 'Not Applied': 'text-slate-500'};
            const row = `<tr class="bg-white border-b border-slate-200 hover:bg-slate-50 transition-all duration-200 ease-in-out table-row-hover" data-id="${b.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap"><div class="flex items-center"><img class="w-10 h-10 rounded-full" src="https://placehold.co/40x40/e2e8f0/475569?text=${b.name.charAt(0)}" alt="${b.name}"><div class="pl-3"><div class="text-base font-semibold">${b.name}</div><div class="font-normal text-slate-500">${b.id}</div></div></div></td>
                            <td class="px-6 py-4"><div class="flex items-center"><span class="font-bold text-lg text-${scoreColor}">${compositeScore}</span><div class="w-full bg-slate-200 rounded-full h-2.5 ml-3"><div class="bg-${scoreColor} h-2.5 rounded-full" style="width: ${((compositeScore-300)/5.5)}%"></div></div></div></td>
                            <td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold rounded-full" style="background-color: ${riskConfig.color}; color: ${riskConfig.text};">${riskBand}</span></td>
                            <td class="px-6 py-4"><span class="font-medium ${statusMap[b.loanStatus] || 'text-slate-500'}">${b.loanStatus}</span></td>
                            <td class="px-6 py-4 text-center"><button class="view-details-btn font-medium text-indigo-600 hover:underline" data-id="${b.id}">View Details</button></td>
                        </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
        addEventListenersToButtons();
    };

    const animateCountUp = (el, end, isPercentage = false) => {
        let start = parseFloat(el.textContent) || 0;
        const duration = 1500; const frameRate = 1000 / 60; const totalFrames = Math.round(duration / frameRate);
        const increment = (end - start) / totalFrames;
        const counter = () => { start += increment; if (increment > 0 ? start < end : start > end) { el.textContent = isPercentage ? start.toFixed(1) + '%' : Math.ceil(start).toLocaleString(); requestAnimationFrame(counter); } else { el.textContent = isPercentage ? end.toFixed(1) + '%' : end.toLocaleString(); } };
        requestAnimationFrame(counter);
    };

    const updateDashboardCards = (beneficiaries) => {
        animateCountUp(document.getElementById('total-beneficiaries'), beneficiaries.length);
        const lowRiskHighNeed = beneficiaries.filter(b => {
            const factors = getScoreFactors(b);
            const r = calculateRepaymentScore(b, factors);
            const i = calculateIncomeScore(b, factors);
            return getRiskBand(r, i) === 'Low Risk - High Need';
        }).length;
        animateCountUp(document.getElementById('low-risk-high-need'), lowRiskHighNeed);
        animateCountUp(document.getElementById('loans-disbursed'), dashboardMetrics.loansDisbursed);
    };

    const renderRiskDistributionChart = (beneficiaries) => {
        const riskCounts = beneficiaries.reduce((acc, b) => {
            const factors = getScoreFactors(b);
            const riskBand = getRiskBand(calculateRepaymentScore(b, factors), calculateIncomeScore(b, factors));
            acc[riskBand] = (acc[riskBand] || 0) + 1;
            return acc;
        }, {});
        const ctx = document.getElementById('risk-distribution-chart').getContext('2d');
        const chartColors = ['#16a34a', '#0d9488', '#f59e0b', '#eab308', '#f97316', '#ef4444'];
        if (riskChart) riskChart.destroy();
        riskChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(riskCounts), datasets: [{ data: Object.values(riskCounts), backgroundColor: chartColors, borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 20, padding: 20 } } } } });
    };

    const renderLoanStatusChart = (beneficiaries) => {
        const statusCounts = beneficiaries.reduce((acc, b) => { acc[b.loanStatus] = (acc[b.loanStatus] || 0) + 1; return acc; }, {});
        const ctx = document.getElementById('loan-status-chart').getContext('2d');
        const chartColors = {'Active': '#3b82f6', 'Closed': '#16a34a', 'Defaulted': '#ef4444', 'Newly Sanctioned': '#6366f1', 'Pending': '#f59e0b', 'Not Applied': '#64748b'};
        if (loanStatusChart) loanStatusChart.destroy();
        loanStatusChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: Object.keys(statusCounts).map(status => chartColors[status]), borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 20, padding: 20 } } } } });
    };

    const openModal = (beneficiaryId) => {
        const b = mockBeneficiaries.find(b => b.id === beneficiaryId);
        if (!b) return;
        const factors = getScoreFactors(b);
        const r = calculateRepaymentScore(b, factors), i = calculateIncomeScore(b, factors), f = detectFraudRisk(b);
        const compositeScore = calculateCompositeScore(r, i, f);
        const riskBand = getRiskBand(r, i); const riskConfig = riskBandConfig[riskBand];
        document.getElementById('modal-name').textContent = b.name; document.getElementById('modal-id').textContent = b.id; document.getElementById('modal-avatar').src = `https://placehold.co/64x64/e2e8f0/475569?text=${b.name.charAt(0)}`;
        document.getElementById('modal-composite-score').textContent = compositeScore;
        const modalRiskBand = document.getElementById('modal-risk-band');
        modalRiskBand.textContent=riskBand; modalRiskBand.style.backgroundColor=riskConfig.color; modalRiskBand.style.color=riskConfig.text;
        document.getElementById('modal-repayment-score').textContent=r; document.getElementById('modal-income-score').textContent=i; document.getElementById('modal-fraud-score').textContent=`${f}%`;
        document.getElementById('modal-business-activity').textContent=b.business; document.getElementById('modal-location').textContent=b.location; document.getElementById('modal-electricity').textContent=`${b.electricity} kWh/month`; document.getElementById('modal-utility').textContent=b.utility;
        
        const sortedFactors = Object.values(factors).filter(f => f.value !== 0).sort((a, b) => b.value - a.value);
        const positiveFactors = sortedFactors.filter(f => f.value > 0).slice(0, 2);
        const negativeFactors = sortedFactors.filter(f => f.value < 0).slice(0, 1);
        const xaiBreakdown = document.getElementById('xai-breakdown');
        xaiBreakdown.innerHTML = '';
        [...positiveFactors, ...negativeFactors].forEach(factor => {
            const isPositive = factor.value > 0;
            xaiBreakdown.innerHTML += `
                <div class="text-xs p-2 rounded-md ${isPositive ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold ${isPositive ? 'text-green-800' : 'text-red-800'}">${factor.label}</span>
                        <span class="font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">${isPositive ? '+' : ''}${factor.value.toFixed(0)} pts</span>
                    </div>
                    <p class="text-slate-500 text-[11px]">${factor.description}</p>
                </div>`;
        });
        
        document.getElementById('audit-trail').innerHTML = `<p>${new Date().toLocaleString()}: Details Viewed by Admin.</p><p>13/10/2025 - 11:15: Score recalculated after data update.</p><p>01/08/2024 - 09:30: Loan Approved by Officer XYZ.</p>`;
        const ctx = document.getElementById('repayment-chart').getContext('2d');
        if (repaymentChart) repaymentChart.destroy();
        repaymentChart = new Chart(ctx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Repayment Consistency', data: [95, 98, 100, 92, 100, 97], borderColor: '#4F46E5', backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.4, fill: true }] }, options: { scales: { y: { beginAtZero: true, max: 110 } } } });
        const modal = document.getElementById('beneficiary-modal');
        modal.classList.remove('hidden'); modal.querySelector('#modal-content').classList.remove('modal-scale-leave'); modal.querySelector('#modal-content').classList.add('modal-scale-enter');
    };

    const closeModal = () => {
        const modal = document.getElementById('beneficiary-modal'); const modalContent = modal.querySelector('#modal-content');
        modalContent.classList.remove('modal-scale-enter'); modalContent.classList.add('modal-scale-leave');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    const openAddModal = () => {
        const modal = document.getElementById('add-beneficiary-modal');
        modal.classList.remove('hidden'); modal.querySelector('#add-modal-content').classList.remove('modal-scale-leave'); modal.querySelector('#add-modal-content').classList.add('modal-scale-enter');
    };

    const closeAddModal = () => {
        document.getElementById('add-beneficiary-form').reset();
        const modal = document.getElementById('add-beneficiary-modal'); const modalContent = modal.querySelector('#add-modal-content');
        modalContent.classList.remove('modal-scale-enter'); modalContent.classList.add('modal-scale-leave');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    const populateDropdowns = () => {
        const riskBandSelect = document.getElementById('filter-risk-band');
        const loanStatusSelect = document.getElementById('filter-loan-status');
        const rescoreSelect = document.getElementById('rescore-beneficiary-select');
        const riskBands = [...new Set(mockBeneficiaries.map(b => {
            const factors = getScoreFactors(b);
            return getRiskBand(calculateRepaymentScore(b, factors), calculateIncomeScore(b, factors));
        }))];
        riskBandSelect.innerHTML = '<option value="all">All Risk Bands</option>';
        riskBands.sort().forEach(rb => riskBandSelect.innerHTML += `<option value="${rb}">${rb}</option>`);
        const statuses = [...new Set(mockBeneficiaries.map(b => b.loanStatus))];
        loanStatusSelect.innerHTML = '<option value="all">All Statuses</option>';
        statuses.sort().forEach(s => loanStatusSelect.innerHTML += `<option value="${s}">${s}</option>`);
        rescoreSelect.innerHTML = '<option value="" disabled selected>Choose a beneficiary</option>';
        mockBeneficiaries.forEach(b => rescoreSelect.innerHTML += `<option value="${b.id}">${b.name} (${b.id})</option>`);
    };

    const applyFilters = () => {
        const searchTerm = document.getElementById('search-beneficiary').value.toLowerCase();
        const riskBand = document.getElementById('filter-risk-band').value;
        const loanStatus = document.getElementById('filter-loan-status').value;
        const filtered = mockBeneficiaries.filter(b => {
            const factors = getScoreFactors(b);
            const bRiskBand = getRiskBand(calculateRepaymentScore(b, factors), calculateIncomeScore(b, factors));
            return (b.name.toLowerCase().includes(searchTerm) || b.id.toLowerCase().includes(searchTerm)) &&
                   (riskBand === 'all' || bRiskBand === riskBand) &&
                   (loanStatus === 'all' || b.loanStatus === loanStatus);
        });
        renderTable(filtered);
    };
    
    // --- EVENT LISTENERS & LOGIC ---
    document.getElementById('check-eligibility-btn').addEventListener('click', () => {
        const btn = document.getElementById('check-eligibility-btn'), btnText = document.getElementById('btn-text'), loader = document.getElementById('btn-loader');
        const resultDiv = document.getElementById('lending-result');
        const beneficiaryId = document.getElementById('loan-beneficiary-id').value.toUpperCase();
        const loanAmount = parseFloat(document.getElementById('loan-amount').value);
        resultDiv.innerHTML = ''; resultDiv.classList.add('hidden');
        if (!beneficiaryId || !loanAmount) { resultDiv.innerHTML = `<p class="text-red-500 text-sm">Please fill in both Beneficiary ID and Loan Amount.</p>`; resultDiv.classList.remove('hidden'); return; }
        const beneficiary = mockBeneficiaries.find(b => b.id === beneficiaryId);
        if (!beneficiary) { resultDiv.innerHTML = `<p class="text-red-500 text-sm">Beneficiary ID not found.</p>`; resultDiv.classList.remove('hidden'); return; }
        btn.disabled = true; btnText.textContent = 'Processing...'; loader.classList.remove('hidden');
        setTimeout(() => {
            const factors = getScoreFactors(beneficiary);
            const r = calculateRepaymentScore(beneficiary, factors), i = calculateIncomeScore(beneficiary, factors), f = detectFraudRisk(beneficiary);
            const compositeScore = calculateCompositeScore(r, i, f); const riskBand = getRiskBand(r, i);
            if (compositeScore >= 650 && !riskBand.startsWith('High Risk')) {
                resultDiv.innerHTML = `<div class="stamp stamp-approved"><span>Approved</span><span class="text-xs">Score: ${compositeScore}</span></div>`;
                beneficiary.loanStatus = 'Newly Sanctioned'; dashboardMetrics.loansDisbursed++; fullRefresh();
            } else { resultDiv.innerHTML = `<div class="stamp stamp-denied"><span>Denied</span><span class="text-xs">Score: ${compositeScore}</span></div><p class="mt-2 text-sm text-slate-600">Score below threshold for digital approval.</p>`; }
            resultDiv.classList.remove('hidden'); btn.disabled = false; btnText.textContent = 'Check Eligibility & Sanction'; loader.classList.add('hidden');
        }, 1500);
    });

    document.getElementById('loan-beneficiary-id').addEventListener('input', (e) => {
        const beneficiaryId = e.target.value.toUpperCase();
        const beneficiary = mockBeneficiaries.find(b => b.id === beneficiaryId);
        const btnText = document.getElementById('btn-text');
        const loanAmountInput = document.getElementById('loan-amount');

        if (beneficiary && beneficiary.loanStatus === 'Pending') {
            loanAmountInput.value = beneficiary.loanAmount;
            btnText.textContent = 'Review & Sanction Application';
        } else {
            btnText.textContent = 'Check Eligibility & Sanction';
        }
    });

    document.getElementById('suggest-amount-btn').addEventListener('click', () => {
        const beneficiaryId = document.getElementById('loan-beneficiary-id').value.toUpperCase();
        const loanAmountInput = document.getElementById('loan-amount');
        if (!beneficiaryId) { loanAmountInput.value = ''; loanAmountInput.placeholder = 'Enter an ID first'; return; }
        const beneficiary = mockBeneficiaries.find(b => b.id === beneficiaryId);
        if (!beneficiary) { loanAmountInput.value = ''; loanAmountInput.placeholder = 'Beneficiary not found'; return; }
        const factors = getScoreFactors(beneficiary);
        const r = calculateRepaymentScore(beneficiary, factors), i = calculateIncomeScore(beneficiary, factors), f = detectFraudRisk(beneficiary);
        const compositeScore = calculateCompositeScore(r, i, f);
        const suggestedAmount = Math.max(0, Math.floor(((compositeScore - 500) / 350) * 80000 / 5000) * 5000);
        loanAmountInput.value = suggestedAmount;
    });

    document.getElementById('retrain-model-btn').addEventListener('click', () => {
        const btn = document.getElementById('retrain-model-btn'), btnText = document.getElementById('retrain-btn-text'), loader = document.getElementById('retrain-loader'), feedbackDiv = document.getElementById('retrain-feedback');
        btn.disabled = true; btnText.textContent = 'Training...'; loader.classList.remove('hidden');
        feedbackDiv.classList.add('hidden');

        setTimeout(() => {
            const oldAccuracy = modelWeights.accuracy;
            const accuracyChange = (Math.random() * 1.5).toFixed(1);
            modelWeights.accuracy = Math.min(99.9, oldAccuracy + parseFloat(accuracyChange));
            modelWeights.composite.repayment_w += Math.random() * 0.02;
            modelWeights.composite.income_w -= Math.random() * 0.01;

            animateCountUp(document.getElementById('model-accuracy'), modelWeights.accuracy, true);
            feedbackDiv.textContent = `Model updated. Accuracy improved by ${accuracyChange}%. Dashboard scores are now recalibrated.`;
            feedbackDiv.className = 'p-3 mb-4 text-sm text-center rounded-lg bg-green-100 text-green-800';
            feedbackDiv.classList.remove('hidden');
            
            btn.disabled = false; btnText.textContent = 'Retrain Model'; loader.classList.add('hidden');
            fullRefresh();
            setTimeout(() => feedbackDiv.classList.add('hidden'), 5000);
        }, 2000);
    });

    document.getElementById('rescore-btn').addEventListener('click', () => {
        const beneficiaryId = document.getElementById('rescore-beneficiary-select').value, newElectricity = parseFloat(document.getElementById('new-electricity').value), newMobile = parseFloat(document.getElementById('new-mobile').value), resultDiv = document.getElementById('rescore-result');
        resultDiv.innerHTML = '';
        if (!beneficiaryId) { resultDiv.innerHTML = 'Please select a beneficiary.'; resultDiv.className = 'mt-2 text-center text-sm font-medium text-red-500'; return; }
        const beneficiary = mockBeneficiaries.find(b => b.id === beneficiaryId);
        const oldFactors = getScoreFactors(beneficiary);
        const oldR = calculateRepaymentScore(beneficiary, oldFactors), oldI = calculateIncomeScore(beneficiary, oldFactors), oldF = detectFraudRisk(beneficiary);
        const oldCompositeScore = calculateCompositeScore(oldR, oldI, oldF);
        if (newElectricity) beneficiary.electricity = newElectricity;
        if (newMobile) beneficiary.mobile = newMobile;
        const newFactors = getScoreFactors(beneficiary);
        const newR = calculateRepaymentScore(beneficiary, newFactors), newI = calculateIncomeScore(beneficiary, newFactors), newF = detectFraudRisk(beneficiary);
        const newCompositeScore = calculateCompositeScore(newR, newI, newF);
        const scoreChange = newCompositeScore - oldCompositeScore, changeColor = scoreChange > 0 ? 'text-green-600' : scoreChange < 0 ? 'text-red-600' : 'text-slate-600', changeIcon = scoreChange > 0 ? '▲' : scoreChange < 0 ? '▼' : '●';
        resultDiv.innerHTML = `Score Updated: ${oldCompositeScore} → <strong class="text-lg">${newCompositeScore}</strong> <span class="${changeColor}">${changeIcon} ${scoreChange}</span>`;
        resultDiv.className = 'mt-2 text-center text-sm font-medium text-slate-800';
        fullRefresh();
        setTimeout(() => resultDiv.innerHTML = '', 4000);
    });

    document.getElementById('add-beneficiary-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newId = 'BEN' + String(mockBeneficiaries.length + 1).padStart(3, '0');
        const loanAmount = parseInt(document.getElementById('new-loan-amount').value) || 0;
        const loanTenure = parseInt(document.getElementById('new-loan-tenure').value) || 12;

        const newBeneficiary = {
            id: newId,
            name: document.getElementById('new-name').value,
            location: document.getElementById('new-location').value,
            business: document.getElementById('new-business').value,
            electricity: parseInt(document.getElementById('new-electricity-add').value),
            mobile: parseInt(document.getElementById('new-mobile-add').value),
            loanAmount: loanAmount,
            tenure: loanTenure,
            repayments: 0,
            utility: 'On-Time',
            repeat: false,
            loanStatus: loanAmount > 0 ? 'Pending' : 'Not Applied'
        };
        
        mockBeneficiaries.push(newBeneficiary);
        fullRefresh();
        closeAddModal();
    });

    document.getElementById('search-beneficiary').addEventListener('input', applyFilters);
    document.getElementById('filter-risk-band').addEventListener('change', applyFilters);
    document.getElementById('filter-loan-status').addEventListener('change', applyFilters);
    document.getElementById('notification-btn').addEventListener('click', () => document.getElementById('notification-panel').classList.toggle('hidden'));
    const addEventListenersToButtons = () => document.querySelectorAll('.view-details-btn').forEach(b => b.addEventListener('click', (e) => openModal(e.target.dataset.id)));
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    document.getElementById('beneficiary-modal').addEventListener('click', (e) => e.target.id === 'beneficiary-modal' && closeModal());
    document.getElementById('add-beneficiary-btn').addEventListener('click', openAddModal);
    document.getElementById('close-add-modal-btn').addEventListener('click', closeAddModal);
    document.getElementById('add-beneficiary-modal').addEventListener('click', (e) => e.target.id === 'add-beneficiary-modal' && closeAddModal());
    const topBtn = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => { topBtn.classList.toggle('hidden', window.scrollY <= 300); });
    topBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

    // --- INITIALIZATION ---
    fullRefresh();
});
</script>
</body>
</html>